# fzh 아키텍처 문서

## 개요

`fzh`는 Haskell로 작성된 퍼지 파인더(fuzzy finder) TUI 애플리케이션입니다. [Brick](https://github.com/jtdaugherty/brick) 라이브러리를 기반으로 터미널 사용자 인터페이스를 구현하며, fzf와 유사한 기능을 제공합니다.

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                         Main (app/Main.hs)                      │
│                      애플리케이션 진입점                            │
└─────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Lib (src/Lib.hs)                        │
│                    Brick App 정의 및 모듈 통합                     │
└─────────────────────────────────────────────────────────────────┘
                                  │
          ┌───────────────────────┼───────────────────────┐
          ▼                       ▼                       ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   UI (UI.hs)    │     │ Event (Event.hs)│     │  Vty (Vty.hs)   │
│   화면 렌더링     │     │   이벤트 처리      │     │  터미널 I/O      │
└─────────────────┘     └─────────────────┘     └─────────────────┘
          │                       │
          ▼                       ▼
┌─────────────────┐     ┌─────────────────┐
│ Types (Types.hs)│     │ Fuzzy (Fuzzy.hs)│
│   타입 정의       │     │   퍼지 매칭       │
└─────────────────┘     └─────────────────┘
          │
          ▼
┌──────────────────┐
│Config (Config.hs)│
│   설정 관리        │
└──────────────────┘
```

## 모듈 상세 설명

### 1. Main (app/Main.hs)
애플리케이션의 진입점으로, 다음 역할을 수행합니다:
- 입력 소스 결정 (stdin 파이프 또는 파일 시스템 재귀 탐색)
- 키바인딩 설정 로드
- Brick TUI 실행
- 선택된 아이템 출력

### 2. Lib (src/Lib.hs)
Brick 앱의 핵심 정의를 담당합니다:
- `App` 타입 정의 (드로잉, 이벤트 핸들링, 속성 맵)
- 하위 모듈들의 re-export
- `buildVtyFromTty` 함수 제공

### 3. Types (src/Types.hs)
애플리케이션의 핵심 데이터 타입을 정의합니다:

| 타입 | 설명 |
|------|------|
| `Name` | Brick 위젯 식별자 |
| `AppConfig` | 앱 설정 (너비, 속성, 키바인딩) |
| `AppState` | 앱 상태 (아이템, 필터 결과, 검색어, 설정) |

### 4. Config (src/Config.hs)
설정 파일 관리를 담당합니다:
- `KeyBindingStyle`: Emacs/Vim 키바인딩 스타일
- `KeyBindingConfig`: 키바인딩 설정 레코드
- YAML 파일 파싱 (`~/.config/fzh/keybindings.yaml`)

### 5. Event (src/Event.hs)
사용자 입력 이벤트를 처리합니다:
- Emacs 스타일: `C-p/C-n` 이동, `C-g` 종료, `C-u` 삭제
- Vim 스타일: `C-k/C-j` 이동, `C-c` 종료, `C-u` 삭제
- 검색어 입력/삭제 처리
- 리스트 네비게이션

### 6. Fuzzy (src/Fuzzy.hs)
퍼지 매칭 알고리즘을 구현합니다:
- `fuzzyMatchScore`: 쿼리와 텍스트 간 매칭 점수 계산
- `filterItems`: 아이템 필터링 및 점수순 정렬
- 경로 깊이 기반 정렬 (얕은 경로 우선)

### 7. UI (src/UI.hs)
화면 렌더링을 담당합니다:
- `renderSearchBox`: 검색 입력 박스
- `renderResultList`: 필터링된 결과 리스트
- `renderInfo`: 아이템 개수 정보
- `renderKeyBindingHelp`: 키바인딩 도움말

### 8. Vty (src/Vty.hs)
터미널 I/O를 처리합니다:
- `/dev/tty` 직접 접근으로 파이프 입력 지원
- 커스텀 Vty 인스턴스 생성

## 데이터 흐름

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   stdin/     │────▶│    Main      │────▶│  AppState    │
│  파일시스템     │     │  (입력 수집)  │      │  (초기화)     │
└──────────────┘     └──────────────┘     └──────────────┘
                                                  │
                                                  ▼
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   stdout     │◀────│    Main      │◀────│  Brick App   │
│  (선택 결과)   │     │  (결과 출력)   │     │  (TUI 루프)   │
└──────────────┘     └──────────────┘     └──────────────┘
                                                  │
                     ┌────────────────────────────┼────────────────────────────┐
                     │                            │                            │
                     ▼                            ▼                            ▼
              ┌──────────────┐            ┌──────────────┐            ┌──────────────┐
              │     UI       │            │    Event     │            │    Fuzzy     │
              │  (렌더링)     │             │  (입력 처리)  │            │  (필터링)      │
              └──────────────┘            └──────────────┘            └──────────────┘
```

## 이벤트 처리 흐름

```
사용자 키 입력
      │
      ▼
┌─────────────────┐
│  handleEvent    │
│  (키바인딩 분기)   │
└─────────────────┘
      │
      ├─── Emacs ──▶ handleEmacsEvent
      │
      └─── Vim ────▶ handleVimEvent
                          │
                          ▼
              ┌─────────────────────┐
              │  상태 변경 함수들      │
              │  - appendChar       │
              │  - deleteChar       │
              │  - clearQuery       │
              │  - moveUp/moveDown  │
              └─────────────────────┘
                          │
                          ▼
              ┌─────────────────────┐
              │  updateSearchQuery  │
              │  (필터링 갱신)        │
              └─────────────────────┘
```

## 의존성 구조

```yaml
주요 외부 라이브러리:
  - brick: TUI 프레임워크
  - vty/vty-unix: 터미널 추상화
  - vector: 효율적인 배열 처리
  - text: 텍스트 처리
  - yaml: 설정 파일 파싱
  - directory/filepath: 파일 시스템 접근
```

## 설계 원칙

1. **순수 함수 분리**: 상태 변경 로직은 순수 함수로 구현 (`Pure` 주석)
2. **효과 격리**: I/O 작업은 명시적으로 분리 (`Effect` 주석)
3. **모듈화**: 각 모듈은 단일 책임 원칙 준수
4. **설정 가능성**: 키바인딩 스타일을 외부 설정으로 변경 가능
5. **파이프 지원**: stdin 파이프와 터미널 입력 모두 지원

## 파일 구조

```
fzh/
├── app/
│   └── Main.hs          # 진입점
├── src/
│   ├── Lib.hs           # 앱 정의 및 re-export
│   ├── Types.hs         # 타입 정의
│   ├── Config.hs        # 설정 관리
│   ├── Event.hs         # 이벤트 처리
│   ├── Fuzzy.hs         # 퍼지 매칭
│   ├── UI.hs            # UI 렌더링
│   └── Vty.hs           # 터미널 I/O
├── config/
│   └── keybindings.yaml # 키바인딩 설정 예시
├── test/
│   └── Spec.hs          # 테스트
└── package.yaml         # 프로젝트 설정
```
